
## Маршрутизация средств

**Приоритет использования средств для использования баланса проекта:**

1. Бонусы

2. Физическое лицо

3. Юридическое лицо

Пример:

У клиента бонусов 100, на балансе проекта  юрика - 100 рублей, физик 50 рублей. Как потратятся 225 рублей? Вначале 100 рублей бонусов, потом 50 рублей физика, потом, 75 рублей юрика.

*В отчет УПД попадет 75 рублей юрика.*

**Приоритет использования средств при перечислении средств с основного баланса на баланс проекта:**

1. Физическое лицо

2. Юридическая лицо

Пример:

На основном счету юрика - 100, на основном счету физика - 200. Клиент перечисляет с основного счета 250 рублей, как возьмутся деньги с основного баланса? Возьмется 200 рублей физика и 50 рублей юрика.

*В отчет УПД попадет 50 рублей юрика.*

## Уточненная структура балансов и логика работы

**1. Таблица ``` Balance ``` (Основной баланс пользователя)**

| **Поле** | **Описание** |
|-------------|-------------|
| user_id   |Идентификатор пользователя.|
| amount    |Деньги, внесенные **физ. лицом** (карта, электронные платежи и т.д.).|
| invoice_amount    |Деньги, внесенные **юр. лицом** (банковские переводы по инвойсу).|
| bonuses    |Бонусные средства (используются в первую очередь при списании).|

**2. Таблица ``` ProjectBalance ``` (Баланс проекта)**

| **Поле** | **Описание** |
|-------------|-------------|
| project_id   |Идентификатор проекта.|
| amount    |Средства от **физ. лица** (из ``` Balance.amount ```).|
| invoice_amount    |Средства от **юр. лица** (из ``` Balance.invoice_amount ```).|

## Логика операций

**1. Пополнение баланса**

- **Для физ. лица:**
    + Платеж картой → зачисляется в ``` Balance.amount ```.

- **Для юр. лица:**
    + Банковский перевод по инвойсу → зачисляется в ``` Balance.invoice_amount ```.

2. **Перевод средств на проект (``` Balance → ProjectBalance ```)**

Пользователь переводит **X рублей:**

1. **Списание** из ``` Balance ``` происходит в порядке приоритета:

    - Сначала ``` bonuses ``` (если есть),

    - Затем ``` amount ``` (деньги физ. лица),

    - В конце ``` invoice_amount ``` (деньги юр. лица).

2. **Зачисление** в ``` ProjectBalance ```:
    - Средства распределяются пропорционально источникам списания.

    - **Пример:**
        + В ```Balance```: ```bonuses = 0```, ```amount = 100```, ```invoice_amount = 300```.

        + Пользователь переводит **400 ₽** →
            + ```ProjectBalance.amount += 100``` (из ```Balance.amount```),

            + ```ProjectBalance.invoice_amount += 300``` (из ```Balance.invoice_amount```).

**3. Списание средств в биллинге (использование ресурсов проекта)**

Приоритет списания с ```ProjectBalance```:

1. ```bonuses``` (если имеются бонусы),

2. ```amount``` (деньги физ. лица),

3. ```invoice_amount``` (деньги юр. лица).

## Отображение в ЛК пользователя

- Основной баланс: ```Balance.amount + Balance.invoice_amount``` (без разделения).

- Баланс проекта: ```ProjectBalance.amount + ProjectBalance.invoice_amount``` (без разделения).

- Баланс бонусов: ```Balance.bonuses```